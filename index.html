/* JS INTEGRALE PROFESSIONALE - SANDRO PROJECT OS */
document.addEventListener("DOMContentLoaded", () => {
  // Caricamento dati persistenti
  let notes = JSON.parse(localStorage.getItem("notes")) || [];
  let categories = JSON.parse(localStorage.getItem("categories")) || [{n: "Generale", c: "#34c759"}];
  let trash = JSON.parse(localStorage.getItem("trash")) || [];

  // Selettori pannelli
  const panels = {
    note: document.getElementById("notePanel"),
    cat: document.getElementById("categoryPanel"),
    trash: document.getElementById("trashPanel"),
    settings: document.getElementById("settingsPanel")
  };

  const openP = (id) => { 
    panels[id].classList.remove("hidden"); 
    setTimeout(() => panels[id].classList.add("show"), 10); 
    if(id === 'trash') renderTrash();
  };
  
  const closeP = (id) => { 
    panels[id].classList.remove("show"); 
    setTimeout(() => panels[id].classList.add("hidden"), 300); 
  };

  // Eventi Icon Bar
  document.getElementById("addNoteBtn").onclick = () => {
    document.getElementById("noteTitle").value = "";
    document.getElementById("noteText").value = "";
    openP("note");
  };
  document.getElementById("categoriesBtn").onclick = () => openP("cat");
  document.getElementById("trashBtn").onclick = () => openP("trash");
  document.getElementById("settingsBtn").onclick = () => openP("settings");

  // Chiusura pannelli
  document.getElementById("closeNotePanel").onclick = () => closeP("note");
  document.getElementById("closeCategoryPanel").onclick = () => closeP("cat");
  document.getElementById("closeTrashPanel").onclick = () => closeP("trash");
  document.getElementById("closeSettingsPanel").onclick = () => closeP("settings");

  // --- RENDERING NOTE ---
  window.renderNotes = () => {
    const cont = document.getElementById("notesContainer");
    cont.innerHTML = notes.length === 0 ? "<p style='text-align:center; opacity:0.5;'>Nessuna nota</p>" : "";
    notes.forEach((n, i) => {
      const d = document.createElement("div");
      d.className = "note";
      d.style.borderLeft = `10px solid ${n.colore || '#ffa500'}`;
      d.innerHTML = `
        <div onclick="window.editNote(${i})">
          <h3>${n.t}</h3>
          <p>${n.txt}</p>
        </div>
        <button onclick="window.moveToTrash(${i})" style="background:#ff3b30; color:white; border:none; border-radius:8px; padding:5px 10px; margin-top:10px; cursor:pointer;">Sposta nel Cestino ğŸ—‘ï¸</button>
      `;
      cont.appendChild(d);
    });
  };

  // --- SALVATAGGIO NOTA ---
  document.getElementById("saveNoteBtn").onclick = () => {
    const t = document.getElementById("noteTitle").value;
    const txt = document.getElementById("noteText").value;
    if(t || txt) {
      notes.push({t, txt, colore: '#ffa500'});
      localStorage.setItem("notes", JSON.stringify(notes));
      renderNotes();
      closeP("note");
    }
  };

  // --- CESTINO ---
  window.moveToTrash = (i) => {
    trash.push(notes[i]);
    notes.splice(i, 1);
    localStorage.setItem("notes", JSON.stringify(notes));
    localStorage.setItem("trash", JSON.stringify(trash));
    renderNotes();
  };

  window.renderTrash = () => {
    const tList = document.getElementById("trashList");
    tList.innerHTML = trash.length === 0 ? "Cestino vuoto" : "";
    trash.forEach((n, i) => {
      tList.innerHTML += `
        <div class="category-row">
          <span>${n.t}</span>
          <button onclick="window.restoreNote(${i})">ğŸ”„</button>
          <button onclick="window.permanentDelete(${i})">âŒ</button>
        </div>`;
    });
  };

  window.restoreNote = (i) => {
    notes.push(trash[i]);
    trash.splice(i, 1);
    localStorage.setItem("notes", JSON.stringify(notes));
    localStorage.setItem("trash", JSON.stringify(trash));
    renderTrash(); renderNotes();
  };

  window.permanentDelete = (i) => {
    trash.splice(i, 1);
    localStorage.setItem("trash", JSON.stringify(trash));
    renderTrash();
  };

  // --- CATEGORIE ---
  window.renderCats = () => {
    const list = document.getElementById("categoryList");
    list.innerHTML = "";
    categories.forEach((c, i) => {
      list.innerHTML += `
        <div class="category-row">
          <div style="display:flex; align-items:center;">
             <div style="width:20px; height:20px; border-radius:50%; background:${c.c}; margin-right:10px;"></div>
             <span>${c.n}</span>
          </div>
          <button onclick="window.delC(${i})" style="background:none; border:none; cursor:pointer;">ğŸ—‘ï¸</button>
        </div>`;
    });
  };

  document.getElementById("saveCategoryBtn").onclick = () => {
    const n = document.getElementById("newCategoryName").value;
    const color = document.getElementById("categoryColorPicker").value;
    if(n) {
      categories.push({n, c: color});
      localStorage.setItem("categories", JSON.stringify(categories));
      renderCats();
      document.getElementById("newCategoryName").value = "";
    }
  };

  window.delC = (i) => {
    categories.splice(i, 1);
    localStorage.setItem("categories", JSON.stringify(categories));
    renderCats();
  };

  // Avvio Iniziale
  renderNotes();
  renderCats();
});
