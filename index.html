<!-- Popup -->
<div id="popup">
  <div id="popupContent">
    <div id="popupHeader">
      <div id="popupTitle"></div>

      <div>
        <button id="copyBtn">ğŸ“‹ Copia</button>
        <button id="openEditorBtn">âœï¸ Editor</button>
        <button id="downloadBtn">â¬‡ï¸ TXT</button>
        <button id="textareaBtn">ğŸ“ Box</button>
        <button id="closePopup">âœ•</button>
      </div>
    </div>

    <pre><code id="popupBody"></code></pre>
  </div>
</div>

<script>
  const popup = document.getElementById("popup");
  const popupTitle = document.getElementById("popupTitle");
  const popupBody = document.getElementById("popupBody");

  const closePopupBtn = document.getElementById("closePopup");
  const copyBtn = document.getElementById("copyBtn");
  const openEditorBtn = document.getElementById("openEditorBtn");
  const downloadBtn = document.getElementById("downloadBtn");
  const textareaBtn = document.getElementById("textareaBtn");

  function openPopup(type) {
    popup.style.display = "flex";
    popupTitle.textContent = type.toUpperCase();

    let codice = "";

    if (type === "html") {
      popupBody.className = "language-html";
      codice = codiceHTML;
    }
    if (type === "css") {
      popupBody.className = "language-css";
      codice = codiceCSS;
    }
    if (type === "js") {
      popupBody.className = "language-javascript";
      codice = codiceJS;
    }

    popupBody.innerHTML = "";
    popupBody.appendChild(document.createTextNode(codice));

    hljs.highlightElement(popupBody);
  }

  closePopupBtn.onclick = () => popup.style.display = "none";
  popup.onclick = e => { if (e.target === popup) popup.style.display = "none"; };

  /* 1) COPIA */
  copyBtn.onclick = async () => {
    const text = popupBody.innerText;

    try {
      await navigator.clipboard.writeText(text);
      copyBtn.textContent = "âœ”ï¸ Copiato";
      setTimeout(() => copyBtn.textContent = "ğŸ“‹ Copia", 1500);
      return;
    } catch (e) {}

    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "fixed";
    ta.style.opacity = "0";
    document.body.appendChild(ta);
    ta.select();
    try {
      document.execCommand("copy");
      copyBtn.textContent = "âœ”ï¸ Copiato";
    } catch (e) {
      copyBtn.textContent = "âŒ Errore";
    }
    setTimeout(() => copyBtn.textContent = "ğŸ“‹ Copia", 1500);
    document.body.removeChild(ta);
  };

  /* 2) APRI IN EDITOR */
  openEditorBtn.onclick = () => {
    const editorWindow = window.open("", "_blank");
    editorWindow.document.write(`
      <textarea style="width:100%;height:100%;font-size:14px;font-family:SF Mono,Menlo,monospace;">
${popupBody.innerText}
      </textarea>
    `);
    editorWindow.document.close();
  };

  /* 3) SCARICA FILE TXT */
  downloadBtn.onclick = () => {
    const blob = new Blob([popupBody.innerText], { type: "text/plain" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = popupTitle.textContent + ".txt";
    a.click();

    URL.revokeObjectURL(url);
  };

  /* 4) MOSTRA IN TEXTAREA */
  textareaBtn.onclick = () => {
    const box = window.open("", "_blank");
    box.document.write(`
      <textarea style="width:100%;height:100%;font-size:14px;font-family:SF Mono,Menlo,monospace;">
${popupBody.innerText}
      </textarea>
    `);
    box.document.close();
  };
</script>
